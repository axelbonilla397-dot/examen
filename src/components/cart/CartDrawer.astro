---
import { Icon } from "astro-icon/components";
---

<div id="cart-drawer-wrapper" class="relative z-9999">
    <!-- Overlay -->
    <div
        id="cart-overlay"
        class="fixed inset-0 bg-slate-950/60 backdrop-blur-sm z-9998 opacity-0 pointer-events-none transition-opacity duration-500 ease-out"
    >
    </div>

    <!-- Drawer -->
    <div
        id="cart-drawer"
        class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-[-20px_0_50px_rgba(0,0,0,0.2)] z-9999 flex flex-col translate-x-full transition-transform duration-500 cubic-bezier(0.16, 1, 0.3, 1)"
    >
        <!-- Header -->
        <div
            class="p-8 border-b border-slate-100 flex items-center justify-between"
        >
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 bg-primary rounded-2xl flex items-center justify-center text-white relative"
                >
                    <Icon name="lucide:shopping-bag" class="w-5 h-5" />
                    <span
                        id="cart-count-badge"
                        class="hidden absolute -top-2 -right-2 bg-secondary text-white font-black text-[10px] w-6 h-6 flex items-center justify-center rounded-full border-2 border-white"
                    >
                        0
                    </span>
                </div>
                <div>
                    <h2
                        class="text-xl font-black text-slate-950 uppercase italic tracking-tighter"
                    >
                        Your Cart
                    </h2>
                    <p
                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                    >
                        Premium Selection
                    </p>
                </div>
            </div>
            <button
                id="close-cart"
                class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-50 transition-colors text-slate-400 hover:text-slate-950 cursor-pointer"
            >
                <Icon name="lucide:x" class="w-6 h-6" />
            </button>
        </div>

        <!-- Content -->
        <div
            id="cart-items-container"
            class="flex-1 overflow-y-auto custom-scrollbar p-8"
        >
            <!-- Empty State -->
            <div
                id="empty-cart-state"
                class="hidden h-full flex-col items-center justify-center space-y-8 text-center px-4"
            >
                <div class="space-y-4">
                    <h3
                        class="text-2xl font-black text-slate-950 uppercase tracking-tighter"
                    >
                        Your cart is empty
                    </h3>
                    <p class="text-slate-400 font-medium leading-relaxed">
                        It looks like you haven't found that special tone yet.
                        Explore our collection.
                    </p>
                </div>
                <button
                    id="go-to-catalog"
                    class="bg-primary text-white rounded-2xl py-5 px-10 font-black uppercase tracking-widest text-xs hover:bg-primary/80 transition-all cursor-pointer"
                >
                    Back to store
                </button>
            </div>

            <!-- Items List -->
            <div id="cart-items-list" class="space-y-8">
                <!-- Items will be injected here -->
            </div>
        </div>

        <!-- Footer -->
        <div
            id="cart-footer"
            class="hidden p-8 border-t border-slate-100 space-y-6 bg-slate-50/50"
        >
            <div class="space-y-4">
                <div
                    class="flex items-center justify-between text-slate-400 font-bold text-[10px] uppercase tracking-widest"
                >
                    <span>Shipping</span>
                    <span class="text-emerald-500">Free</span>
                </div>
                <div
                    id="total-savings-container"
                    class="hidden items-center justify-between bg-emerald-50 text-emerald-600 font-black text-[10px] uppercase tracking-widest px-4 py-2 rounded-xl mt-2 animate-pulse"
                >
                    <span>Total Savings</span>
                    <span id="total-savings-value">- $ 0</span>
                </div>
                <div
                    class="pt-4 flex items-center justify-between border-t border-slate-100 mt-4"
                >
                    <span
                        class="text-xl font-black text-slate-950 uppercase italic tracking-tighter"
                        >Total</span
                    >
                    <span
                        id="total-price-value"
                        class="text-2xl font-black text-slate-950 italic"
                        >$ 0</span
                    >
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button
                    id="clear-cart-btn"
                    class="bg-primary text-white rounded-2xl py-4 font-black uppercase tracking-widest text-[10px] hover:bg-primary/80 transition-all cursor-pointer"
                >
                    Clear
                </button>
                <button
                    id="checkout-btn"
                    class="bg-slate-950 text-white rounded-2xl py-4 font-black uppercase tracking-widest text-[10px] hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group cursor-pointer"
                >
                    Checkout
                    <Icon
                        name="lucide:arrow-right"
                        class="w-4 h-4 group-hover:translate-x-1 transition-transform"
                    />
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #cbd5e1;
    }

    .cubic-bezier {
        transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
    }
</style>

<script>
    import {
        isCartOpen,
        cartItems,
        toggleCart,
        removeFromCart,
        updateQuantity,
        clearCart,
        totalPrice,
        totalSavings,
        totalItems,
    } from "../../store/cartStore";
    import { toast } from "sonner";

    const overlay = document.getElementById("cart-overlay");
    const drawer = document.getElementById("cart-drawer");
    const closeBtn = document.getElementById("close-cart");
    const itemsList = document.getElementById("cart-items-list");
    const emptyState = document.getElementById("empty-cart-state");
    const footer = document.getElementById("cart-footer");
    const cartCountBadge = document.getElementById("cart-count-badge");
    const totalPriceValue = document.getElementById("total-price-value");
    const totalSavingsContainer = document.getElementById(
        "total-savings-container",
    );
    const totalSavingsValue = document.getElementById("total-savings-value");
    const clearCartBtn = document.getElementById("clear-cart-btn");
    const checkoutBtn = document.getElementById("checkout-btn");
    const goToCatalogBtn = document.getElementById("go-to-catalog");

    function formatPrice(price: number) {
        return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
        })
            .format(price)
            .replace("$", "$ ");
    }

    // Subscribe to cart open state
    isCartOpen.subscribe((isOpen) => {
        if (isOpen) {
            overlay?.classList.remove("opacity-0", "pointer-events-none");
            overlay?.classList.add("opacity-100");
            drawer?.classList.remove("translate-x-full");
        } else {
            overlay?.classList.add("opacity-0", "pointer-events-none");
            overlay?.classList.remove("opacity-100");
            drawer?.classList.add("translate-x-full");
        }
    });

    // Subscribe to cart items
    cartItems.subscribe((items) => {
        if (!itemsList || !emptyState || !footer || !cartCountBadge) return;

        if (items.length === 0) {
            emptyState.classList.remove("hidden");
            itemsList.innerHTML = "";
            footer.classList.add("hidden");
            cartCountBadge.classList.add("hidden");
        } else {
            emptyState.classList.add("hidden");
            footer.classList.remove("hidden");
            cartCountBadge.classList.remove("hidden");
            cartCountBadge.textContent = String(
                items.reduce((acc, item) => acc + item.quantity, 0),
            );

            itemsList.innerHTML = items
                .map(
                    (item) => `
                <div class="flex gap-6 group" data-id="${item.id}">
                    <div class="w-24 h-32 bg-slate-100 rounded-2xl overflow-hidden relative shrink-0 border border-slate-100">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                    </div>

                    <div class="flex-1 flex flex-col justify-between py-1">
                        <div class="space-y-1">
                            <div class="flex items-start justify-between">
                                <h4 class="text-sm font-black text-slate-950 uppercase italic tracking-tight pr-4">
                                    ${item.name}
                                </h4>
                                <button class="remove-item text-slate-300 hover:text-red-500 transition-colors cursor-pointer" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${item.category || "Premium"}</p>
                        </div>

                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center bg-slate-50 rounded-xl p-0.5 border border-slate-100">
                                <button class="decrease-qty w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white transition-all text-slate-400 hover:text-slate-950 disabled:opacity-30 cursor-pointer" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                </button>
                                <span class="w-8 text-center text-xs font-black italic">${item.quantity}</span>
                                <button class="increase-qty w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white transition-all text-slate-400 hover:text-slate-950 disabled:opacity-30 cursor-pointer" data-id="${item.id}" ${item.stock !== undefined && item.quantity >= item.stock ? "disabled" : ""}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                </button>
                            </div>
                            <div class="text-right">
                                ${item.discount ? `<p class="text-[10px] font-bold text-slate-400 line-through decoration-red-500/50 mb-0.5">${formatPrice(item.price * item.quantity)}</p>` : ""}
                                <p class="text-base font-black text-slate-950 italic">
                                    ${formatPrice(item.price * (1 - (item.discount || 0) / 100) * item.quantity)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `,
                )
                .join("");

            // Add event listeners for buttons
            document.querySelectorAll(".remove-item").forEach((btn) => {
                btn.addEventListener("click", () =>
                    removeFromCart(btn.getAttribute("data-id") || ""),
                );
            });
            document.querySelectorAll(".decrease-qty").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id") || "";
                    const item = items.find((i) => i.id === id);
                    if (item) updateQuantity(id, item.quantity - 1);
                });
            });
            document.querySelectorAll(".increase-qty").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id") || "";
                    const item = items.find((i) => i.id === id);
                    if (item) {
                        const result = updateQuantity(id, item.quantity + 1);
                        if (!result.success) {
                            toast.error(result.message);
                        }
                    }
                });
            });
        }
    });

    // Subscribe to totals
    totalPrice.subscribe((price) => {
        if (totalPriceValue) totalPriceValue.textContent = formatPrice(price);
    });

    totalSavings.subscribe((savings) => {
        if (!totalSavingsContainer || !totalSavingsValue) return;
        if (savings > 0) {
            totalSavingsContainer.classList.remove("hidden");
            totalSavingsValue.textContent = `- ${formatPrice(savings)}`;
        } else {
            totalSavingsContainer.classList.add("hidden");
        }
    });

    // Control buttons
    closeBtn?.addEventListener("click", toggleCart);
    overlay?.addEventListener("click", toggleCart);
    clearCartBtn?.addEventListener("click", clearCart);
    goToCatalogBtn?.addEventListener("click", toggleCart);
    checkoutBtn?.addEventListener("click", () => {
        toggleCart();
        window.location.href = "/checkout";
    });
</script>
