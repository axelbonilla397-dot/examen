---
import { products } from "../../data/products";
import CardProduct from "../products/CardProduct.astro";
import Pagination from "../ui/Pagination.astro";

const ITEMS_PER_PAGE = 8;
const totalPages = Math.ceil(products.length / ITEMS_PER_PAGE);
---

<section class="pb-10 bg-base-100" id="featured-products-section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-12">
            <h2
                class="text-3xl font-black text-slate-900 uppercase tracking-tighter"
            >
                Featured Products
            </h2>
        </div>

        <div
            id="product-grid"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 min-h-[800px]"
        >
            {
                products.map((product) => (
                    <div class="product-card-wrapper hidden">
                        <CardProduct
                            title={product.title}
                            price={product.price}
                            stock={product.stock}
                            images={product.images}
                            slug={product.slug}
                        />
                    </div>
                ))
            }
        </div>

        <!-- Pagination Controls -->
        <div class="flex justify-center mt-12" id="pagination-controls">
            <Pagination currentPage={1} totalPages={totalPages} />
        </div>
    </div>
</section>

<script>
    function initPagination() {
        const ITEMS_PER_PAGE = 8;
        const grid = document.getElementById("product-grid");
        const wrappers = document.querySelectorAll(".product-card-wrapper");
        const paginationButtons = document.querySelectorAll(".pagination-btn");

        if (!grid || wrappers.length === 0) return;

        let currentPage = 1;
        const totalPages = Math.ceil(wrappers.length / ITEMS_PER_PAGE);

        function renderProducts(page: number) {
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;

            wrappers.forEach((wrapper, index) => {
                if (index >= start && index < end) {
                    wrapper.classList.remove("hidden");
                } else {
                    wrapper.classList.add("hidden");
                }
            });
        }

        function updateControls(page: number) {
            paginationButtons.forEach((btn: any) => {
                const btnPage = parseInt(btn.dataset.page);

                // Reset states
                btn.classList.remove("btn-active");
                btn.disabled = false;

                // Set active state
                if (btnPage === page) {
                    btn.classList.add("btn-active");
                }

                // Handle Prev/Next buttons logic
                if (isNaN(btnPage)) {
                    // This shouldn't happen based on my new component logic,
                    // but let's check the dataset.page values.
                }

                // Disable Prev if on first page
                if (btn.textContent.trim() === "«" && page === 1) {
                    btn.disabled = true;
                    // Update data-page for prev button to be current - 1
                    btn.dataset.page = page - 1;
                }

                // Disable Next if on last page
                if (btn.textContent.trim() === "»" && page === totalPages) {
                    btn.disabled = true;
                    // Update data-page for next button to be current + 1
                    btn.dataset.page = page + 1;
                }

                // Update Prev/Next targets
                if (btn.textContent.trim() === "«") {
                    btn.dataset.page = page - 1;
                }
                if (btn.textContent.trim() === "»") {
                    btn.dataset.page = page + 1;
                }
            });
        }

        function goToPage(page: number) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderProducts(currentPage);
            updateControls(currentPage);

            // Optional: Scroll to top of grid
            // const section = document.getElementById("featured-products-section");
            // section?.scrollIntoView({ behavior: 'smooth' });
        }

        // Attach listeners
        paginationButtons.forEach((btn: any) => {
            btn.onclick = () => {
                const targetPage = parseInt(btn.dataset.page);
                if (!isNaN(targetPage)) {
                    goToPage(targetPage);
                }
            };
        });

        // Initial render
        renderProducts(currentPage);
        updateControls(currentPage);
    }

    // Init on load
    initPagination();

    // Init on View Transitions navigation
    document.addEventListener("astro:page-load", initPagination);
</script>
